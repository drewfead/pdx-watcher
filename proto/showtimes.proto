syntax = "proto3";

package showtimes;

option go_package = "github.com/drewfead/pdx-watcher/proto";

import "google/protobuf/timestamp.proto";
import "proto/cli/v1/cli.proto";

service ShowtimeService {
    option (cli.v1.service_config) = {config_message: "ShowtimeConfig"};
    option (cli.v1.service) = {
        name: "showtimes"
        description: "List showtimes from Portland theaters"
    };

    // ListShowtimes streams all showtimes from a supported theater
    rpc ListShowtimes(ListShowtimesRequest) returns (stream ListShowtimesResponse) {
        option (cli.v1.command) = {
            name: "list-showtimes"
            description: "Stream showtimes from a theater (Hollywood Theatre, Cinemagic, Cinema 21)"
        };
    }
}

enum PdxSite {
    None = 0;
    HollywoodTheatre = 1 [(cli.v1.enum_value) = {name: "hollywood-theatre"}];
    Cinemagic = 2 [(cli.v1.enum_value) = {name: "cinemagic"}];
    Cinema21 = 3 [(cli.v1.enum_value) = {name: "cinema21"}];
}

message ListShowtimesRequest {
    // Omit for all theaters (interleaved); pass multiple times for specific theaters.
    repeated PdxSite from = 1 [(cli.v1.flag) = {
        name: "from"
        usage: "Theater(s) to list showtimes from (hollywood-theatre, cinemagic, cinema21). Repeat for multiple; omit for all."
        placeholder: "SITE"
    }];

    // Time filtering options (mutually exclusive with after/before)
    optional google.protobuf.Timestamp after = 2 [(cli.v1.flag) = {
        name: "after"
        usage: "Only showtimes after this time (RFC3339)"
        placeholder: "TIME"
    }];
    optional google.protobuf.Timestamp before = 3 [(cli.v1.flag) = {
        name: "before"
        usage: "Only showtimes before this time (RFC3339)"
        placeholder: "TIME"
    }];

    optional int32 limit = 6 [(cli.v1.flag) = {
        name: "limit"
        usage: "Max number of showtimes per page"
        placeholder: "N"
    }];
    optional string anchor = 7 [(cli.v1.flag) = {
        name: "anchor"
        usage: "Page token from previous response for pagination"
        placeholder: "TOKEN"
    }];

    // Display only: times are shown in this IANA timezone. Server ignores this.
    optional string output_timezone = 8 [(cli.v1.flag) = {
        name: "timezone"
        usage: "Display times in this IANA timezone (e.g. America/Los_Angeles). Default: CLI local time"
        placeholder: "TZ"
    }];
}

message ListShowtimesResponse {
    Showtime showtime = 1;  // the showtime (present for all messages except potentially the last)
    optional string next_anchor = 2;  // token for the next page (only set on the last message if more results exist)
    optional PdxSite site = 3;  // source theater for correct per-row display when interleaved
}

message Showtime {
    string id = 1;
    string summary = 2;
    optional string description = 3;
    optional google.protobuf.Timestamp start_time = 4;
    optional google.protobuf.Timestamp end_time = 5;
    optional string location = 6;

    ScreeningInfo screening = 10;
    MovieInfo movie = 11;
}

message ScreeningInfo {
    optional string title = 1;
    optional string series = 2;
    optional string host = 3;
    optional string subhed = 4;  // e.g. "in 35mm" from venue listing
    repeated Link links = 10;
}

message MovieInfo {
    optional string title = 1;
    optional string tagline = 2;
    optional string overview = 3;
    repeated Link links = 10;
}

message Link {
    string href = 1;
    optional string display = 10;
}

message ShowtimeConfig {
    TMDBConfig tmdb = 1;
}

message TMDBConfig {
    string api_key = 1;
}